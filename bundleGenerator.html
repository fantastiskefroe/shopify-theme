
<!DOCTYPE html>
<html>
<head>
  <title>Bundle Configurator</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="shortcut icon" href="https://cdn.shopify.com/s/files/1/0276/3902/1652/files/FantastiskeFroe_logo_mini_32x32.png?v=1583103209" type="image/png">
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Courgette&family=Roboto+Mono&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.12/vue.min.js" integrity="sha512-BKbSR+cfyxLdMAsE0naLReFSLg8/pjbgfxHh/k/kUC82Hy7r6HtR5hLhobaln2gcTvzkyyehrdREdjpsQwy2Jw==" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js" integrity="sha512-bZS47S7sPOxkjU/4Bt0zrhEtWx0y0CRkhEp8IckzK+ltifIIE9EMIMTuT/mEzoIMewUINruDBIR/jJnbguonqQ==" crossorigin="anonymous"></script>

  <script src="//cdn.jsdelivr.net/npm/sortablejs@1.8.4/Sortable.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/Vue.Draggable/2.20.0/vuedraggable.umd.min.js"></script>

  <script type="module" src="https://unpkg.com/ionicons@5.4.0/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule="" src="https://unpkg.com/ionicons@5.4.0/dist/ionicons/ionicons.js"></script>
  
  <style>
    body, html, #app {
      padding: 0;
      margin:  0;
      border:  0;
      width:  100%;
      height: 100%;

      font-family: 'Roboto Mono', monospace;
    }

    .fr {float: right;}
    .fl {float: left;}

    h1,h2,h3,h4,h5,h6 {
      font-family: 'Courgette', cursive;
      margin:0;
      font-size: 1rem;
      
      text-align: left;
    }

    label {
      cursor: pointer;
    }

    input[type=checkbox] {
      width: 1.25rem;
      height: 1.25rem;
      margin: 0;
    }

    h2.title {
      font-size: 1.25rem;
    }

    h3.title {
      font-size: 1rem;
      font-family: 'Roboto Mono';
    }

    .title,.sku {
      padding-left: 1rem;
    }
    
    .left {
      float: left;
    }
    .right {
      float: right;
    }

    .text-small {
      font-size: 0.8rem;
    }
    .text-green {
      color: green;
    }
    .strikethrough {
      text-decoration: line-through;
    }

    .filter, 
    .bundle-variants {
      box-sizing: border-box;
      position: fixed;
      background: #314536;
      color: white;
      z-index: 1;
      width: 100%;
      height: 4rem;
      padding: 1rem;
      font-size: 1rem;
    }

    .filter {top: 0;}
    
    .bundle-variants {bottom: 0;}

    .filter input[type="text"],
    .bundle-variants input[type="text"] {
      font-size: 1rem;
      font-family: 'Roboto Mono', monospace;
    }

    .filter select,
    .bundle-variants select {
      font-size: 1.1rem;
      width: 10rem;
      font-family: 'Roboto Mono', monospace;
    }

    .filter ion-icon,
    .bundle-variants ion-icon {
      font-size: 1rem;
      margin-left:   0.5rem;
      margin-right: -0.5rem;
    }

    .bundle-variants ion-icon {
      cursor: pointer;
    }

    .bundle-variant {
      border: 1px solid white;
      padding: 0.2rem;
      padding-bottom: 0.3rem;
      border-radius: 0.2rem;
      margin-right: 0.5rem;
    }

    .bundle-variant.selected {
      background: white;
      color: #314536;
    }

    .bundle-variant:hover {
      border-width: 2px;
    }

    .mainWindow {
      background: #e8e8e1;
      position: relative;
      top: 4rem;
      margin: 0;
      border: 0;
      height: calc(100% - 8rem);
      width: 100%;
      box-sizing: border-box;

      /* overflow: hidden; */

      display: grid;
      grid-template-columns: 55% 40%;
      grid-column-gap: 2%;
      justify-content: center;
   }

    .products {
      justify-self: right;
      height: 100%;
      overflow-y: auto;
      box-sizing: border-box;
    }

    tr td:nth-child(3) {
      width: 14rem;
    }
    .product .image, .variant .checkbox {
      width: 6rem;
      text-align: center;
    }
    .product .image img {
      height: 4rem;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      max-width: 60rem;
      margin: auto;
    }

    table td {
      border: 1px solid #ddd;
      padding: 0.2rem;
    }

    table tr.product { background-color: white; }
    table tr.variant { background-color: #f2f2f2; }

    .bundle-variant-cart {
      transition: max-height 0.5s ease-in;
      max-height: calc(100vh - 8rem);
      overflow: hidden;

    }
    .bundle-variant-cart.hidden {
      transition: max-height 0.5s ease-out;
      max-height: 0px;
    }

    .foldHandle {
      display: block;
      padding: 0.5rem 1rem;
      cursor: pointer;
      border-bottom: 1px solid #314536;
      border-top: 1px solid #314536;
      margin: 0.5rem 0;
      font-weight: bold;
    }


    .bundlecart {
      overflow: hidden;
      height: 100%;
      width: 100%;
      overflow-y: auto;
      justify-self: left;
    }

    .cart-product {
      display: grid;
      grid-template-columns: min-content min-content auto min-content
    }

    .cart-product .dragHandle, .cart-product .remove-button {
      padding: 0.5rem;
      place-self: center;
      cursor: grab;
    }
    
    .cart-product .image {
      padding: 0 0.5rem;
    }

    .cart-product .titles > * {
      margin: 0;
      padding: 0;
    }

    .cart-product .titles .title {
      font-weight: bold;
    }
    .cart-product .titles .subtitle {
      font-size: 0.8rem;
    }
    .cart-product .titles .price {
      font-size: 0.8rem;
    }

    .cart-product .titles .price .discount {
      margin-left: 2rem;
    }
    .cart-product .titles .price input {
      width: 2rem;
      text-align: right;
    }


    .cart-product .remove-button {
      cursor: pointer;
    }


  </style>
</head>
<body>
  <div id="app">
    <div class="filter">
      <ion-icon name="search-outline"></ion-icon>
      <input type="text" v-model:value="filter" placeholder="Filter">
      <select v-model="filterType">
        <option value="" selected>Types</option>
        <option v-for="type in types" v-bind:value="type">{{ type }}</option>
      </select>
      <select v-model="filterTag">
        <option value="" selected>Tags</option>
        <option v-for="tag in tags" v-bind:value="tag">{{ tag }}</option>
      </select>
      <label for="inBundleFilter">In bundle variant:</label>
      <input type="checkbox" name="inBundleFilter" v-model:value="filterOnlyInSelected">
    </div>

    <div class="mainWindow">
      <div class="products">
        <table>
          <template  v-for="product in filteredProducts">
            <tr class="product">
              <td class="image">
                <img v-bind:src="'https:' + product.image"
                    crossorigin="anonymous"
                    referrerpolicy="no-referrer">
              </td>
              <td><h2 class="title">{{ decode(product.title) }}</h2></td>
              <td><span class="sku">{{ product.sku }}</span></td>
            </tr>
            <tr class="variant" v-for="variant in product.variants" >
              <td class="checkbox">
                <label :for="variant.id">
                  <input 
                    :key="variant.id"
                    type="checkbox"
                    v-if="selectedVariantIndex >= 0 && isChecked(product.handle + '/' + variant.id)"
                    @input="toggleItem(product.handle + '/' + variant.id)"
                    checked
                    :id="variant.id"/>
                  <input 
                    :key="variant.id"
                    type="checkbox"
                    v-if="selectedVariantIndex >= 0 && !isChecked(product.handle + '/' + variant.id)"
                    @input="toggleItem(product.handle + '/' + variant.id)"
                    :id="variant.id"/>
                </label>
              </td>
              <td><label :for="variant.id"><h3 class="title">{{ decode(variant.title) }}</span></label></td>
              <td><label :for="variant.id"><!--<span class="sku">{{ variant.sku }}</span>--></label></td>
            </tr>
          </template>
        </table>
      </div>

      <div class="bundlecart">
        <div class="foldable" v-for="(bundleVariant, index) in bundle">
          <span class="foldHandle" @click="fold(index)">{{ bundleVariant.name }} <span class="fr text-small"><span class="strikethrough">{{ priceFormat(bundleVariantPrice(bundleVariant)) }}</span> - <span class="text-green">{{ priceFormat(discountedBundleVariantPrice(bundleVariant)) }} - {{ percentageDiff(bundleVariantPrice(bundleVariant), discountedBundleVariantPrice(bundleVariant)) }}%</span></span></span>

          <draggable class="bundle-variant-cart" v-bind:class="{hidden: selectedVariantIndex != index}" v-model="bundle[index].items" group="cart" @start="drag=true" @end="drag=false" handle=".dragHandle">
            <div class="cart-product" v-for="(item, itemIndex) in bundle[index].items.map(productFromVariant)" :key="item.id">
              <span class="dragHandle">та┐</span>
              <div class="image">
                <img v-bind:src="'https:' + item.image"
                  crossorigin="anonymous"
                  referrerpolicy="no-referrer">
              </div>
              <div class="titles">
                <p class="title">{{ decode(item.title) }}</p>
                <p class="subtitle">{{ decode(item.subtitle) }}</p>
                <div class="price">
                  <span>{{ priceFormat(item.price) }}</span>
                  <span class="discount"> - <input v-model="bundle[index].items[itemIndex].discount" type="text" placeholder="0">%</span>
                  <span> = {{ priceFormat(item.price * (100-item.discount) * 0.01)}}</span>
                </div>
              </div>
              <span class="remove-button" @click="removeItemFromBundleVariant(item.id, index)">тип</span>
            </div>
          </draggable>
        </div>
      </div>
    </div>


    <div class="bundle-variants">
      <ion-icon name="add-outline" @click="addVariant"></ion-icon>
      <input v-if="selectedVariantIndex == -1" v-on:keyup.enter="addVariant"  v-model:value="variant" placeholder="VariantName" type="text" >
      <input v-else v-model:value="bundle[selectedVariantIndex].name" placeholder="VariantName" type="text">

      <span v-for="(v,i) in bundle" class="bundle-variant" v-bind:class="{ selected: selectedVariantIndex == i}" @click="selectBundleVariant(i)">{{v.name}} ({{v.items.length}})</span>

      <ion-icon name="copy-outline" @click="copyResult($event)"></ion-icon>
      <input id="result" type="text" v-bind:value="result" @input="setState($event.target.value)" />
      <span class="fr" @click="setState('')"><ion-icon  name="trash-outline"></ion-icon></span>
    </div>
    
  </div>

  <script>
      var app = new Vue({
        el: '#app',
        data: {
            hasLoaded: false,
            products: [],
            tags: [],
            types: [],
            filter: "",
            filterTag: "",
            filterType: "",
            filterOnlyInSelected: false,
            variant: "",
            selectedVariantIndex: -1,
            bundle: []
        },
        components: {
          'draggable': vuedraggable
        },
        computed: {
          result: function() {
            if(!this.hasLoaded) {
              return;
            }

            let itemToString = function(item) {
              return item.id + (item.discount > 0 ? "/" + item.discount : "");
            } 

            let value = this.bundle.map((b) => b.name + "=" + b.items.map(itemToString).join(":")).join(",");
            localStorage.setItem("result", value);
            return value;
          },
          filteredProducts: function() {
            var self = this;
            var filtered = this.products.filter((product) => 
              (self.filterType.length == 0 || self.filterType == product.type)
                &&
              (self.filterTag.length == 0  || product.tags.includes(self.filterTag))
            );

            if(this.filter.length) {
              filtered = filtered.filter((product) => 
                product.title.toLowerCase().indexOf(self.filter.toLowerCase()) >= 0
              );
            }
            
            if(this.filterOnlyInSelected && this.selectedVariantIndex >= 0) {
              filtered = filtered.filter((product) => 
                self.bundle[self.selectedVariantIndex].items.map( item => item.id.split('/')[0]).includes(product.handle)
              );
            }
            
            return filtered;
          }
        },
        methods: {
          bundleVariantPrice: function(bundleVariant) {
            products = bundleVariant.items.map(this.productFromVariant);
            return products.reduce((sum,item) => sum+(item.price), 0)
          },
          discountedBundleVariantPrice: function(bundleVariant) {
            products = bundleVariant.items.map(this.productFromVariant);
            return products.reduce((sum,item) => sum+(item.price * (100-item.discount) * 0.01), 0)
          },
          percentageDiff: function(a,b) {
            return (100* (a-b)/a).toFixed(2);
          },
          isChecked: function(identifier) {
            if(this.selectedVariantIndex < 0)
              return false;
            return this.bundle[this.selectedVariantIndex].items.filter(i => i.id == identifier).length > 0;
          },
          toggleItem: function(id) {
            if(this.isChecked(id)) {
              this.bundle[this.selectedVariantIndex].items = this.bundle[this.selectedVariantIndex].items.filter(i => i.id != id);
            }
            else {
              this.bundle[this.selectedVariantIndex].items.push({id: id, discount: 0});
            }
          },
          removeItemFromBundleVariant: function(item, index) {
            this.bundle[index].items = this.bundle[index].items.filter(x => x.id != item);
          },
          fold: function(index) {
            this.selectedVariantIndex = this.selectedVariantIndex == index ? -1 : index;
            // $('.bundle-variant-cart.hidden').style()
          },
          priceFormat: function(ears) {
            if (ears == undefined) {
                return 0;
            }
            return "" + (ears/100).toFixed(2) + " DKK";
            
          },
          decode : function(str) {
            var doc = new DOMParser().parseFromString(str, "text/html");
            return doc.documentElement.textContent;
          },
          addVariant: function() {
            this.bundle.push({
              name: this.variant,
              items: []
            });
            this.variant = "";
            // this.selectedVariantIndex = this.bundle.length-1;
          },
          selectBundleVariant: function(i) {
            if(this.selectedVariantIndex == i) {
              this.selectedVariantIndex = -1;
              this.variant = "";
            }
            else 
              this.selectedVariantIndex = i;
          },
          copyResult: function(e) {
            var field = document.getElementById('result');
            field.select();
            field.setSelectionRange(0, 99999);
            document.execCommand("copy");
            // alert("Copied the text");
          },
          productFromVariant: function(item) {
            handle = item.id.split('/')[0];
            variantID = item.id.split('/')[1];
            let products = this.products.filter(p => p.handle == handle);
            if(products.length != 1)
              return null;
            let variants = products[0].variants.filter(v => v.id+"" == variantID);
            if(variants.length != 1)
              return null;
            return {
              id: item.id,
              title: products[0].title,
              subtitle: variants[0].title,
              image: products[0].image,
              type:  products[0].type,
              tags:  products[0].tags,
              price: variants[0].price,
              discount: item.discount
            }
          },
          setState(formattedStr) {
            var self = this;

            let isNotEmpty = (s) => s.length > 0;

            if(formattedStr.length == 0) {
              this.selectedVariantIndex = -1;
              this.bundle = [];
              return;
            }

            const newBundle = formattedStr.split(",").filter(isNotEmpty).map((bundleVariantStr) => {
              let parts = bundleVariantStr.split("=");
              return {
                name: parts[0],
                items: parts[1].split(":").map((idStr) => {
                  let parts = idStr.split("/");
                  if(parts.length < 2 || parts.length > 3)
                    return false;
                  let productHandle = parts[0];
                  let variantId = parts[1];
                  let discount = parts.length >= 3 ? parseInt(parts[2]) : 0
                  let product = self.products.filter((p) => p.handle == productHandle);
                  if(product.length != 1)
                    return false;
                  let variant = product[0].variants.filter((v) => v.id == variantId);
                  if(variant.length != 1)
                    return false;
                  return {
                    id: `${productHandle}/${variantId}`,
                    discount: discount
                  };
                }).filter(x => x !== false)
              }
            });
            if(this.selectedVariantIndex >= newBundle.length)
              this.selectedVariantIndex = -1;
            this.bundle = newBundle;
          }
        },
        mounted: function () {
          this.$nextTick(function () {
            axios
              .get('data.json?'+new Date().toLocaleString("da-dk", {dateStyle: "short", timeStyle: "short"}))
              .then(response => {
                let storeData = (response.data);

                this.products = Object.values(storeData.products);
                this.products.map(p => {
                  
                  p.variants = Object.values(p.variants).map(v => {
                    v.sku = v.sku.replace(/-\d{4}/, "");
                    return v;
                  });
                  p.sku = p.variants[0].sku.replace(/-.$/, "")
                  return p;
                });
                this.products.sort((a,b) => a.sku.localeCompare(b.sku));
                this.tags = storeData.tags.filter(t => !t.startsWith("_"));
                this.types = storeData.types;

                let resultString = localStorage.getItem("result");

                if(resultString) this.setState(resultString);
                this.hasLoaded = true;
              });
          })
        }
      });
  </script>
</body>
</html>
